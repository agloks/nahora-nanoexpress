{"version":3,"file":"proxy.js","sources":["../../../src/packed/defines/proxy.js"],"sourcesContent":["import http from 'http';\nimport https from 'https';\n\nhttp.globalAgent.keepAlive = true;\nhttps.globalAgent.keepAlive = true;\n\nconst httpRequest = (agent, url, config) =>\n  new Promise((resolve, reject) => {\n    agent[config.method](url, config, (response) => {\n      let buff;\n      response.on('data', (chunk) => {\n        chunk = Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk);\n\n        if (!buff) {\n          buff = chunk;\n        } else {\n          buff = Buffer.concat([buff, chunk]);\n        }\n      });\n      response.on('end', () => {\n        response.data = buff;\n\n        resolve(response);\n      });\n      response.on('error', reject);\n    });\n  });\n\nconst prepareProxy = (\n  path,\n  {\n    url,\n    method,\n    enableHeadersProxy = false,\n    restrictedHeaders = [\n      'Host',\n      'Content-Length',\n      'uWebSockets',\n      'Accept-Encoding'\n    ]\n  } = {},\n  wsInstance\n) => {\n  const isAny = method === undefined;\n  const fetchUrl = url.indexOf('*') !== -1 || url.indexOf(':') !== -1;\n  const proxyPathLen = fetchUrl ? path.length : 0;\n  const disallowedHeaders = restrictedHeaders.map((header) =>\n    header.toLowerCase()\n  );\n\n  // Prepared object to return\n  const prepared = {\n    isAny\n  };\n\n  const ssl = url.indexOf('https:') === 0;\n  const agent = ssl ? https : http;\n\n  if (method) {\n    method = method.toLowerCase();\n  }\n\n  // HTTP Request configuration\n  const config = {\n    url,\n    method,\n    headers: {}\n  };\n\n  prepared.method = isAny ? 'any' : method;\n  prepared.http = async (res, req) => {\n    // Allow waiting for request finishing\n    let isAborted = false;\n    res.onAborted(() => {\n      isAborted = true;\n    });\n\n    // Fetch needed methods and configure\n    const httpUrl = fetchUrl ? url + req.getUrl().substr(proxyPathLen) : url;\n\n    config.method = isAny ? req.getMethod() : method;\n\n    // Proxy headers too if it's defined\n    if (enableHeadersProxy) {\n      req.forEach((key, value) => {\n        if (disallowedHeaders.indexOf(key) === -1) {\n          config.headers[key] = value;\n        }\n      });\n    }\n\n    const { data, headers } = await httpRequest(agent, httpUrl, config);\n\n    if (isAborted) {\n      return;\n    }\n\n    res.cork(() => {\n      if (isAborted) {\n        return;\n      }\n\n      if (enableHeadersProxy) {\n        for (const key in headers) {\n          const value = headers[key];\n\n          if (disallowedHeaders.indexOf(key) !== -1) {\n            continue;\n          }\n\n          if (typeof value === 'string') {\n            res.writeHeader(key, value);\n          } else if (value.splice) {\n            for (let i = 0, len = value.length; i < len; i++) {\n              res.writeHeader(key, value[i]);\n            }\n          }\n        }\n      }\n\n      res.end(data);\n    });\n  };\n  if (wsInstance) {\n    prepared.ws = {\n      open(ws, req) {\n        config.method = 'ws';\n\n        const wsUrl =\n          url.replace(/http/, 'ws') +\n          (fetchUrl ? req.getUrl().substr(proxyPathLen) : '');\n\n        ws.instance = new wsInstance(wsUrl);\n\n        ws.instance.on('message', (data) => {\n          ws.send(data);\n        });\n\n        ws.instance.emit('open');\n      },\n      message(ws, message, isBinary) {\n        if (!isBinary) {\n          message = Buffer.from(message).toString('utf8');\n        }\n\n        ws.instance.send(message);\n      },\n      close(ws, code, reason) {\n        ws.instance.close(code, reason);\n      }\n    };\n  }\n\n  return prepared;\n};\n\nexport default (app) => {\n  app.proxy = (path, config, wsInstance) => {\n    const { ws, http, method } = prepareProxy(path, config, wsInstance);\n\n    if (http) {\n      app._app[method](path, http);\n    }\n    if (ws) {\n      app._app.ws(path, ws);\n    }\n    return app;\n  };\n};\n"],"names":[],"mappings":"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"}