{"version":3,"file":"webrtc-server.js","sources":["../../../src/packed/defines/webrtc-server.js"],"sourcesContent":["// Code was used from\n// https://flaviocopes.com/webrtc/\n// thank you\n\nexport default (app) => {\n  app.webRTCServer = (path = '/webrtc', options = {}, ajv) => {\n    const connections = {};\n\n    app.ws(\n      path,\n      options,\n      (req, ws) => {\n        ws.on(\n          'message',\n          ({ action, error, credentials: { id, targetId } = {}, payload }) => {\n            switch (action) {\n              case 'register': {\n                if (connections[id]) {\n                  ws.send(\n                    JSON.stringify({ action: 'register', success: false })\n                  );\n                } else {\n                  connections[id] = ws;\n                  ws.id = id;\n\n                  ws.send(\n                    JSON.stringify({ action: 'register', success: true })\n                  );\n                }\n                break;\n              }\n              case 'offer': {\n                const connection = connections[targetId];\n\n                if (connection) {\n                  connection.targetId = ws.id;\n                  ws.targetId = targetId;\n\n                  connection.send(\n                    JSON.stringify({\n                      action,\n                      credentials: { sourceId: connection.id },\n                      payload\n                    })\n                  );\n                }\n                break;\n              }\n              case 'answer':\n              case 'candidate': {\n                const connection = connections[ws.targetId];\n                if (connection) {\n                  connection.send(\n                    JSON.stringify({\n                      action,\n                      payload\n                    })\n                  );\n                }\n                break;\n              }\n              case 'close': {\n                const { targetId: wsId } = ws;\n                const connection = connections[wsId];\n\n                if (connection) {\n                  connection.send(JSON.stringify({ action: 'close' }));\n                }\n                break;\n              }\n              default: {\n                ws.send(\n                  JSON.stringify({\n                    action: 'error',\n                    error: error || `action[${action}] not found`\n                  })\n                );\n                break;\n              }\n            }\n          }\n        );\n        ws.on('close', () => {\n          const { id, targetId } = ws;\n\n          connections[id] = null;\n          delete connections[id];\n\n          ws.id = null;\n          ws.targetId = null;\n          ws = null;\n\n          const targetConnection = connections[targetId];\n\n          if (targetConnection) {\n            targetConnection.send(JSON.stringify({ action: 'close' }));\n\n            // Clean target user too\n            connections[targetId] = null;\n            delete connections[targetId];\n          }\n        });\n      },\n      ajv\n    );\n\n    return app;\n  };\n};\n"],"names":[],"mappings":";;AAAA;AACA;AACA;AACA;AACA,mBAAe,CAAC,GAAG,KAAK;AACxB,EAAE,GAAG,CAAC,YAAY,GAAG,CAAC,IAAI,GAAG,SAAS,EAAE,OAAO,GAAG,EAAE,EAAE,GAAG,KAAK;AAC9D,IAAI,MAAM,WAAW,GAAG,EAAE,CAAC;AAC3B;AACA,IAAI,GAAG,CAAC,EAAE;AACV,MAAM,IAAI;AACV,MAAM,OAAO;AACb,MAAM,CAAC,GAAG,EAAE,EAAE,KAAK;AACnB,QAAQ,EAAE,CAAC,EAAE;AACb,UAAU,SAAS;AACnB,UAAU,CAAC,EAAE,MAAM,EAAE,KAAK,EAAE,WAAW,EAAE,EAAE,EAAE,EAAE,QAAQ,EAAE,GAAG,EAAE,EAAE,OAAO,EAAE,KAAK;AAC9E,YAAY,QAAQ,MAAM;AAC1B,cAAc,KAAK,UAAU,EAAE;AAC/B,gBAAgB,IAAI,WAAW,CAAC,EAAE,CAAC,EAAE;AACrC,kBAAkB,EAAE,CAAC,IAAI;AACzB,oBAAoB,IAAI,CAAC,SAAS,CAAC,EAAE,MAAM,EAAE,UAAU,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC;AAC1E,mBAAmB,CAAC;AACpB,iBAAiB,MAAM;AACvB,kBAAkB,WAAW,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC;AACvC,kBAAkB,EAAE,CAAC,EAAE,GAAG,EAAE,CAAC;AAC7B;AACA,kBAAkB,EAAE,CAAC,IAAI;AACzB,oBAAoB,IAAI,CAAC,SAAS,CAAC,EAAE,MAAM,EAAE,UAAU,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;AACzE,mBAAmB,CAAC;AACpB,iBAAiB;AACjB,gBAAgB,MAAM;AACtB,eAAe;AACf,cAAc,KAAK,OAAO,EAAE;AAC5B,gBAAgB,MAAM,UAAU,GAAG,WAAW,CAAC,QAAQ,CAAC,CAAC;AACzD;AACA,gBAAgB,IAAI,UAAU,EAAE;AAChC,kBAAkB,UAAU,CAAC,QAAQ,GAAG,EAAE,CAAC,EAAE,CAAC;AAC9C,kBAAkB,EAAE,CAAC,QAAQ,GAAG,QAAQ,CAAC;AACzC;AACA,kBAAkB,UAAU,CAAC,IAAI;AACjC,oBAAoB,IAAI,CAAC,SAAS,CAAC;AACnC,sBAAsB,MAAM;AAC5B,sBAAsB,WAAW,EAAE,EAAE,QAAQ,EAAE,UAAU,CAAC,EAAE,EAAE;AAC9D,sBAAsB,OAAO;AAC7B,qBAAqB,CAAC;AACtB,mBAAmB,CAAC;AACpB,iBAAiB;AACjB,gBAAgB,MAAM;AACtB,eAAe;AACf,cAAc,KAAK,QAAQ,CAAC;AAC5B,cAAc,KAAK,WAAW,EAAE;AAChC,gBAAgB,MAAM,UAAU,GAAG,WAAW,CAAC,EAAE,CAAC,QAAQ,CAAC,CAAC;AAC5D,gBAAgB,IAAI,UAAU,EAAE;AAChC,kBAAkB,UAAU,CAAC,IAAI;AACjC,oBAAoB,IAAI,CAAC,SAAS,CAAC;AACnC,sBAAsB,MAAM;AAC5B,sBAAsB,OAAO;AAC7B,qBAAqB,CAAC;AACtB,mBAAmB,CAAC;AACpB,iBAAiB;AACjB,gBAAgB,MAAM;AACtB,eAAe;AACf,cAAc,KAAK,OAAO,EAAE;AAC5B,gBAAgB,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,GAAG,EAAE,CAAC;AAC9C,gBAAgB,MAAM,UAAU,GAAG,WAAW,CAAC,IAAI,CAAC,CAAC;AACrD;AACA,gBAAgB,IAAI,UAAU,EAAE;AAChC,kBAAkB,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,MAAM,EAAE,OAAO,EAAE,CAAC,CAAC,CAAC;AACvE,iBAAiB;AACjB,gBAAgB,MAAM;AACtB,eAAe;AACf,cAAc,SAAS;AACvB,gBAAgB,EAAE,CAAC,IAAI;AACvB,kBAAkB,IAAI,CAAC,SAAS,CAAC;AACjC,oBAAoB,MAAM,EAAE,OAAO;AACnC,oBAAoB,KAAK,EAAE,KAAK,IAAI,CAAC,OAAO,EAAE,MAAM,CAAC,WAAW,CAAC;AACjE,mBAAmB,CAAC;AACpB,iBAAiB,CAAC;AAClB,gBAAgB,MAAM;AACtB,eAAe;AACf,aAAa;AACb,WAAW;AACX,SAAS,CAAC;AACV,QAAQ,EAAE,CAAC,EAAE,CAAC,OAAO,EAAE,MAAM;AAC7B,UAAU,MAAM,EAAE,EAAE,EAAE,QAAQ,EAAE,GAAG,EAAE,CAAC;AACtC;AACA,UAAU,WAAW,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC;AACjC,UAAU,OAAO,WAAW,CAAC,EAAE,CAAC,CAAC;AACjC;AACA,UAAU,EAAE,CAAC,EAAE,GAAG,IAAI,CAAC;AACvB,UAAU,EAAE,CAAC,QAAQ,GAAG,IAAI,CAAC;AAC7B,UAAU,EAAE,GAAG,IAAI,CAAC;AACpB;AACA,UAAU,MAAM,gBAAgB,GAAG,WAAW,CAAC,QAAQ,CAAC,CAAC;AACzD;AACA,UAAU,IAAI,gBAAgB,EAAE;AAChC,YAAY,gBAAgB,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,MAAM,EAAE,OAAO,EAAE,CAAC,CAAC,CAAC;AACvE;AACA;AACA,YAAY,WAAW,CAAC,QAAQ,CAAC,GAAG,IAAI,CAAC;AACzC,YAAY,OAAO,WAAW,CAAC,QAAQ,CAAC,CAAC;AACzC,WAAW;AACX,SAAS,CAAC,CAAC;AACX,OAAO;AACP,MAAM,GAAG;AACT,KAAK,CAAC;AACN;AACA,IAAI,OAAO,GAAG,CAAC;AACf,GAAG,CAAC;AACJ,CAAC;;;;"}